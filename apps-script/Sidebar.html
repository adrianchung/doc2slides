<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Google Sans', Roboto, Arial, sans-serif;
      font-size: 14px;
      padding: 16px;
      margin: 0;
      color: #202124;
    }

    h2 {
      font-size: 16px;
      font-weight: 500;
      margin: 0 0 16px 0;
      color: #202124;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      font-size: 12px;
      font-weight: 500;
      color: #5f6368;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    select, textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid #dadce0;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
      transition: border-color 0.2s;
    }

    select:focus, textarea:focus {
      outline: none;
      border-color: #4285f4;
    }

    textarea {
      min-height: 100px;
      resize: vertical;
    }

    .help-text {
      font-size: 12px;
      color: #5f6368;
      margin-top: 6px;
    }

    .button-group {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }

    button {
      flex: 1;
      padding: 12px 16px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    button.primary {
      background-color: #4285f4;
      color: white;
    }

    button.primary:hover:not(:disabled) {
      background-color: #3367d6;
    }

    button.secondary {
      background-color: #f1f3f4;
      color: #202124;
    }

    button.secondary:hover:not(:disabled) {
      background-color: #e8eaed;
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .status {
      margin-top: 16px;
      padding: 12px;
      border-radius: 8px;
      font-size: 13px;
    }

    .status.loading {
      background-color: #e8f0fe;
      color: #1967d2;
    }

    .status.success {
      background-color: #e6f4ea;
      color: #137333;
    }

    .status.error {
      background-color: #fce8e6;
      color: #c5221f;
    }

    .status a {
      color: inherit;
      font-weight: 500;
    }

    .spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #1967d2;
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 1s linear infinite;
      margin-right: 8px;
      vertical-align: middle;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .info-box {
      background-color: #f8f9fa;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 20px;
      font-size: 13px;
      color: #5f6368;
    }

    .preview-section {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid #dadce0;
    }

    .preview-title {
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 12px;
      color: #202124;
    }

    .slide-preview {
      background-color: #f8f9fa;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 8px;
    }

    .slide-preview h4 {
      font-size: 13px;
      font-weight: 500;
      margin: 0 0 8px 0;
      color: #202124;
    }

    .slide-preview ul {
      margin: 0;
      padding-left: 20px;
      font-size: 12px;
      color: #5f6368;
    }

    .slide-preview li {
      margin-bottom: 4px;
    }

    .connection-status {
      font-size: 11px;
      color: #5f6368;
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid #dadce0;
      text-align: center;
    }

    .connection-status.connected {
      color: #137333;
    }

    .connection-status.disconnected {
      color: #c5221f;
    }
  </style>
</head>
<body>
  <h2>Generate Executive Slides</h2>

  <div class="info-box">
    Transform this document into a professional presentation optimized for executive review.
  </div>

  <div class="form-group">
    <label for="slideCount">Number of Slides</label>
    <select id="slideCount">
      <option value="3">3 slides - Brief overview</option>
      <option value="5" selected>5 slides - Standard</option>
      <option value="7">7 slides - Detailed</option>
      <option value="10">10 slides - Comprehensive</option>
    </select>
    <div class="help-text">Choose based on meeting length and content depth</div>
  </div>

  <div class="form-group">
    <label for="customPrompt">Custom Instructions (Optional)</label>
    <textarea id="customPrompt" placeholder="e.g., Focus on Q4 metrics and customer feedback. Emphasize cost savings."></textarea>
    <div class="help-text">Add specific guidance for how content should be summarized</div>
  </div>

  <div class="button-group">
    <button id="previewBtn" class="secondary" onclick="previewSlides()">Preview</button>
    <button id="generateBtn" class="primary" onclick="generateSlides()">Generate</button>
  </div>

  <div id="status" class="status" style="display: none;"></div>

  <div id="previewSection" class="preview-section" style="display: none;">
    <div class="preview-title">Slide Preview</div>
    <div id="previewContent"></div>
  </div>

  <div id="connectionStatus" class="connection-status">Checking connection...</div>

  <script>
    // Check connection on load
    document.addEventListener('DOMContentLoaded', function() {
      checkConnection();
    });

    function checkConnection() {
      google.script.run
        .withSuccessHandler(onConnectionResult)
        .withFailureHandler(onConnectionError)
        .testConnection();
    }

    function onConnectionResult(result) {
      const statusEl = document.getElementById('connectionStatus');
      if (result.success) {
        statusEl.className = 'connection-status connected';
        statusEl.textContent = 'Connected to server';
      } else {
        statusEl.className = 'connection-status disconnected';
        statusEl.textContent = 'Server unavailable: ' + result.message;
      }
    }

    function onConnectionError(error) {
      const statusEl = document.getElementById('connectionStatus');
      statusEl.className = 'connection-status disconnected';
      statusEl.textContent = 'Connection check failed';
    }

    function getConfig() {
      return {
        slideCount: parseInt(document.getElementById('slideCount').value),
        customPrompt: document.getElementById('customPrompt').value.trim()
      };
    }

    function setButtonsDisabled(disabled) {
      document.getElementById('generateBtn').disabled = disabled;
      document.getElementById('previewBtn').disabled = disabled;
    }

    function showLoading(message) {
      const status = document.getElementById('status');
      status.style.display = 'block';
      status.className = 'status loading';
      status.innerHTML = '<span class="spinner"></span>' + message;
    }

    function showSuccess(message) {
      const status = document.getElementById('status');
      status.style.display = 'block';
      status.className = 'status success';
      status.innerHTML = message;
    }

    function showError(message) {
      const status = document.getElementById('status');
      status.style.display = 'block';
      status.className = 'status error';
      status.textContent = 'Error: ' + message;
    }

    function generateSlides() {
      setButtonsDisabled(true);
      document.getElementById('generateBtn').textContent = 'Generating...';
      showLoading('Analyzing document and creating slides...');
      document.getElementById('previewSection').style.display = 'none';

      google.script.run
        .withSuccessHandler(onGenerateSuccess)
        .withFailureHandler(onGenerateError)
        .generateSlides(getConfig());
    }

    function onGenerateSuccess(result) {
      setButtonsDisabled(false);
      document.getElementById('generateBtn').textContent = 'Generate';

      if (result.success) {
        showSuccess('Slides created! <a href="' + result.slidesUrl + '" target="_blank">Open Presentation</a>');
      } else {
        showError(result.error);
      }
    }

    function onGenerateError(error) {
      setButtonsDisabled(false);
      document.getElementById('generateBtn').textContent = 'Generate';
      showError(error.message || 'An unexpected error occurred');
    }

    function previewSlides() {
      setButtonsDisabled(true);
      document.getElementById('previewBtn').textContent = 'Loading...';
      showLoading('Generating preview...');
      document.getElementById('previewSection').style.display = 'none';

      google.script.run
        .withSuccessHandler(onPreviewSuccess)
        .withFailureHandler(onPreviewError)
        .previewSlides(getConfig());
    }

    function onPreviewSuccess(result) {
      setButtonsDisabled(false);
      document.getElementById('previewBtn').textContent = 'Preview';
      document.getElementById('status').style.display = 'none';

      if (result.success && result.structure) {
        displayPreview(result.structure);
      } else {
        showError(result.error || 'Failed to generate preview');
      }
    }

    function onPreviewError(error) {
      setButtonsDisabled(false);
      document.getElementById('previewBtn').textContent = 'Preview';
      showError(error.message || 'An unexpected error occurred');
    }

    function displayPreview(structure) {
      const previewSection = document.getElementById('previewSection');
      const previewContent = document.getElementById('previewContent');

      let html = '';

      if (structure.title) {
        html += '<div class="slide-preview"><h4>Title: ' + escapeHtml(structure.title) + '</h4></div>';
      }

      if (structure.slides && structure.slides.length > 0) {
        structure.slides.forEach(function(slide, index) {
          html += '<div class="slide-preview">';
          html += '<h4>Slide ' + (index + 1) + ': ' + escapeHtml(slide.title) + '</h4>';
          if (slide.bullets && slide.bullets.length > 0) {
            html += '<ul>';
            slide.bullets.forEach(function(bullet) {
              html += '<li>' + escapeHtml(bullet) + '</li>';
            });
            html += '</ul>';
          }
          html += '</div>';
        });
      }

      previewContent.innerHTML = html;
      previewSection.style.display = 'block';
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  </script>
</body>
</html>
